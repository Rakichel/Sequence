using System.Collections;
using UnityEngine;

namespace PlayerInfo
{

    /// <summary>
    /// 플레이어의 공격 기능을 담당하는 클래스입니다.
    /// </summary>
    [RequireComponent(typeof(Player))]
    public class PlayerAttack : MonoBehaviour
    {
        private Player _player;
        private Coroutine _attack;
        private Coroutine _combo;
        private float _timer;

        public int Power;                   // 공격력
        public float AnimTime;              // 공격 애니메이션이 걸리는 시간
        public float NextAttackTime;

        private void Start()
        {
            _player = GetComponent<Player>();
        }

        private void Update()
        {
            if (Input.GetKeyDown(KeyCode.X) && _player.PlayerFixedState())
            {
                _attack = StartCoroutine(Attack());
            }
            else if (Input.GetKeyDown(KeyCode.X) && _player.State == PlayerState.Dash)
            {
                _attack = StartCoroutine(Attack());
            }
        }

        /// <summary>
        /// 플레이어가 공격하는 과정을 구현한 코루틴
        /// </summary>
        /// <returns></returns>
        private IEnumerator Attack()
        {
            // 공격 상태 전환
            _player.State = PlayerState.Attack;

            // 공격 범위 지정 및 충돌 체크
            Collider2D collider;
            collider = AttackAreaSelector();
            // 적 피격 시
            if (collider != null)
            {
                // enemy 피격 함수 호출
                if (collider.GetComponent<Enemy>() != null)
                {
                    Enemy enemy = collider.GetComponent<Enemy>();
                    enemy.GetDamage(Power);
                }
            }
            yield return new WaitForSecondsRealtime(AnimTime);
            _timer = 0;
            while (_timer < NextAttackTime)
            {
                yield return new WaitForEndOfFrame();
                _timer = _timer + Time.unscaledDeltaTime;
                if (Input.GetKey(KeyCode.X))
                {
                    _combo = StartCoroutine(Combo());
                    StopCoroutine(_attack);
                }
                else if (Input.anyKey)
                    break;
            }

            // 공격 후 Idle로 전환
            _player.State = PlayerState.Idle;
        }

        private IEnumerator Combo()
        {
            // 공격 상태 전환
            _player.State = PlayerState.Combo;

            // 공격 범위 지정 및 충돌 체크
            Collider2D collider;
            collider = AttackAreaSelector();
            // 적 피격 시
            if (collider != null)
            {
                // enemy 피격 함수 호출
                if (collider.GetComponent<Enemy>() != null)
                {
                    Enemy enemy = collider.GetComponent<Enemy>();
                    enemy.GetDamage(Power);
                }
            }
            yield return new WaitForSecondsRealtime(AnimTime);
            _timer = 0;
            while (_timer < NextAttackTime)
            {
                yield return new WaitForEndOfFrame();
                _timer = _timer + Time.unscaledDeltaTime;
                if (Input.GetKey(KeyCode.X))
                {
                    _attack = StartCoroutine(Attack());
                    StopCoroutine(_combo);
                }
                else if (Input.anyKey)
                    break;
            }
            _player.State = PlayerState.Idle;
        }

        /// <summary>
        /// 공격 방향과 범위를 지정하고 충돌한 Collider정보를 전달하는 함수입니다.
        /// </summary>
        /// <param name="col">충돌이 감지된 Collider 정보를 저장할 변수</param>
        private Collider2D AttackAreaSelector()
        {
            // 보는 방향 기준으로 공격 방향 지정
            if (_player.Direction == PlayerDirection.Right)
            {
                return Physics2D.OverlapBox(transform.position + new Vector3(0.75f, 0.75f), new Vector3(1f, 1f), 0f, 1 << 7);
            }
            else
            {
                return Physics2D.OverlapBox(transform.position + new Vector3(-0.75f, 0.75f), new Vector3(1f, 1f), 0f, 1 << 7);
            }
        }

        private void OnDrawGizmos()
        {
            Gizmos.color = new Color(1f, 0f, 0f, 0.5f);

            if (_player != null)
            {
                if (_player.Direction == PlayerDirection.Right)
                {
                    Gizmos.DrawCube(transform.position + new Vector3(0.75f, 0.75f), new Vector3(1f, 1f));
                }
                else
                {
                    Gizmos.DrawCube(transform.position + new Vector3(-0.75f, 0.75f), new Vector3(1f, 1f));
                }
            }
        }
    }
}
